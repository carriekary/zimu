<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°é‡å­—å¹•å›</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      width: 100%;
      gap: 20px;
    }
    .left-panel, .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .video-container {
      width: 100%;
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
    }
    .video-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: none;
    }
    .subtitle-container {
      width: 100%;
      height: 590px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 15px;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .subtitle {
      margin: 10px 0;
      padding: 12px;
      line-height: 1.8;
      font-size: 15px;
      font-weight: bold;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .color1 { color: #2c3e50; }
    .color2 { color: #e74c3c; }
    /* ç¬”è®°åŠŸèƒ½æ ·å¼ */
    .note-container {
      width: 100%;
      max-width: 600px;
      margin-top: 15px;
      padding: 15px;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #noteInput {
      width: 100%;
      height: 100px;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="file"], input[type="text"], button {
      margin-top: 10px;
      padding: 10px;
      font-size: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      background: #fff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
  <!-- å¼•å…¥ Mammoth.js ç”¨äº DOCX è§£æ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <!-- å¼•å…¥ kuromoji.js ç”¨äºæ—¥è¯­åˆ†è¯ -->
  <script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.js"></script>
</head>
<body>
  <h1>å°é‡å­—å¹•å›</h1>
  <div class="container">
    <!-- å·¦ä¾§ï¼šè§†é¢‘æœç´¢ã€æ’­æ”¾ä¸ç¬”è®°åŠŸèƒ½ -->
    <div class="left-panel">
      <input type="text" id="videoUrl" placeholder="è¾“å…¥ Bilibili æˆ– æ³°å‰§ç½‘é“¾æ¥">
      <button onclick="loadVideo()">æ’­æ”¾è§†é¢‘</button>
      <div class="video-container">
        <iframe id="videoFrame" class="video-iframe" allowfullscreen></iframe>
      </div>
      <!-- æ·»åŠ ç¬”è®°åŠŸèƒ½ -->
      <div class="note-container">
        <textarea id="noteInput" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„ç¬”è®°..."></textarea>
        <button onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
        <div id="noteDisplay"></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šæ–‡ä»¶é€‰æ‹©ã€å­—å¹•è§£æå’Œå­—å¹•æœç´¢ -->
    <div class="right-panel">
      <input type="file" id="fileInput" accept=".ass,.srt,.docx">
      <input type="text" id="searchBox" placeholder="æœç´¢å­—å¹•..." oninput="searchSubtitles()">
      <div class="subtitle-container">
        <div id="subtitles"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // æ„å»ºæ—¥æ–‡åˆ†è¯å™¨ï¼ˆkuromojiï¼‰
    // ---------------------------
    let tokenizer = null;
    kuromoji.builder({
      // ç¡®ä¿å°†ä¸‹è½½å¥½çš„ dict æ–‡ä»¶å¤¹ä¸æ­¤æ–‡ä»¶ç½®äºåŒç›®å½•ä¸‹ï¼Œ
      // æˆ–æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è·¯å¾„ï¼Œå¦‚ "path/to/dict/"
      dicPath: "dict/"
    }).build((err, builtTokenizer) => {
      if (err) {
        console.error("æ„å»ºåˆ†è¯å™¨å¤±è´¥ï¼š", err);
        return;
      }
      tokenizer = builtTokenizer;
      console.log("kuromoji tokenizer åŠ è½½å®Œæ¯•ï¼");
    });

    // ---------------------------
    // ç‰‡å‡åè½¬å¹³å‡åå‡½æ•°
    // ---------------------------
    function katakanaToHiragana(text) {
      return text.replace(/[\u30a1-\u30f6]/g, function(match) {
        return String.fromCharCode(match.charCodeAt(0) - 0x60);
      });
    }

    // ---------------------------
    // è‡ªåŠ¨æ·»åŠ å¹³å‡åï¼ˆFuriganaï¼‰çš„å‡½æ•°
    // ---------------------------
    function addFuriganaToText(text) {
      // å¦‚æœ tokenizer è¿˜æ²¡åŠ è½½å®Œï¼Œç›´æ¥è¿”å›åŸæ–‡æœ¬
      if (!tokenizer) return text;
      const tokens = tokenizer.tokenize(text);
      let result = "";
      tokens.forEach(token => {
        // å¦‚æœ token æœ‰è¯»éŸ³å¹¶ä¸”åŒ…å«æ±‰å­—ï¼Œåˆ™æ·»åŠ å‡å
        if (token.reading && /[ä¸€-é¾¯]/.test(token.surface_form)) {
          let hiragana = katakanaToHiragana(token.reading);
          result += `<ruby>${token.surface_form}<rt>${hiragana}</rt></ruby>`;
        } else {
          result += token.surface_form;
        }
      });
      return result;
    }

    // ---------------------------
    // è§†é¢‘æ’­æ”¾åŠŸèƒ½
    // ---------------------------
    function loadVideo() {
      const inputUrl = document.getElementById('videoUrl').value.trim();
      const videoFrame = document.getElementById('videoFrame');
      try {
        const url = new URL(inputUrl);
        if (url.hostname.includes('bilibili.com')) {
          const bvid = getBilibiliId(inputUrl);
          if (bvid) {
            videoFrame.src = `https://player.bilibili.com/player.html?bvid=${bvid}&autoplay=0`;
            return;
          }
        } else if (url.hostname.includes('taijuwang.com')) {
          videoFrame.src = inputUrl;
          return;
        }
        throw new Error('ä¸æ”¯æŒçš„å¹³å°æˆ–é“¾æ¥æ ¼å¼');
      } catch (e) {
        alert('âš ï¸ é”™è¯¯: è¯·è¾“å…¥æ­£ç¡®çš„è§†é¢‘é“¾æ¥');
      }
    }

    function getBilibiliId(url) {
      const match = url.match(/\/video\/(BV\w+)/);
      return match ? match[1] : null;
    }

    // ---------------------------
    // æ–‡ä»¶è§£æç›¸å…³
    // ---------------------------
    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          if (file.name.endsWith('.docx')) {
            parseDOCX(e.target.result, displaySubtitles);
          } else {
            const content = e.target.result;
            const subtitles = file.name.endsWith('.ass') ? parseASS(content) : parseSRT(content);
            displaySubtitles(subtitles);
          }
        } catch (error) {
          showError(`è§£æå¤±è´¥: ${error.message}`);
        }
      };
      reader.onerror = () => showError('æ–‡ä»¶è¯»å–å¤±è´¥');
      file.name.endsWith('.docx') ? reader.readAsArrayBuffer(file) : reader.readAsText(file, 'utf-8');
    });

    // ç§»é™¤ BOM çš„è¾…åŠ©å‡½æ•°
    function removeBOM(text) {
      return text.replace(/^\uFEFF/, '');
    }

    function parseASS(content) {
      return content.split('\n')
        .filter(line => line.startsWith('Dialogue:'))
        .map(line => {
          const parts = line.split(',');
          return { text: parts.slice(9).join(',').replace(/\\N/g, ' ').replace(/\{.*?\}/g, '') };
        });
    }

    function parseSRT(content) {
      content = removeBOM(content).replace(/\r/g, '');
      return content.split(/\n\n+/)
        .map(block => {
          const lines = block.split('\n').filter(l => l.trim());
          return lines.length >= 3 ? { text: lines.slice(2).join(' ') } : null;
        })
        .filter(Boolean);
    }

    function parseDOCX(arrayBuffer, callback) {
      mammoth.convertToHtml({ arrayBuffer }).then(result => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = result.value;
        const subtitles = Array.from(tempDiv.querySelectorAll('p'))
          .filter(p => p.textContent.trim() !== '')
          .map(p => ({ text: p.textContent.trim() }));
        callback(subtitles);
      }).catch(err => showError(`DOCXè§£æå¤±è´¥: ${err.message}`));
    }

    // ---------------------------
    // æ˜¾ç¤ºå­—å¹• â€”â€” è°ƒç”¨è‡ªåŠ¨æ·»åŠ å¹³å‡åå‡½æ•°
    // ---------------------------
    function displaySubtitles(subtitles) {
      const container = document.getElementById('subtitles');
      container.innerHTML = subtitles.map((sub, index) => `
        <div class="subtitle ${index % 2 ? 'color2' : 'color1'}">
          ${addFuriganaToText(sub.text || 'ç©ºå­—å¹•å†…å®¹')}
        </div>
      `).join('');
    }

    function showError(message) {
      const container = document.getElementById('subtitles');
      container.innerHTML = `<div class="subtitle color2">âŒ ${message}</div>`;
    }

    function searchSubtitles() {
      const query = document.getElementById('searchBox').value.trim().toLowerCase();
      document.querySelectorAll('.subtitle').forEach(subtitle => {
        subtitle.style.display = subtitle.textContent.toLowerCase().includes(query) ? 'block' : 'none';
      });
    }

    // ---------------------------
    // æ–°å¢ç¬”è®°ä¿å­˜åŠŸèƒ½
    // ---------------------------
    function saveNote() {
      const noteText = document.getElementById('noteInput').value.trim();
      if (!noteText) {
        alert("è¯·è¾“å…¥ç¬”è®°å†…å®¹åå†ä¿å­˜ï¼");
        return;
      }
      document.getElementById('noteDisplay').innerHTML = `<p>ğŸ“Œ ${noteText}</p>`;
      alert("ç¬”è®°å·²ä¿å­˜ï¼");
    }
  </script>

  <footer style="margin-top: 20px; padding: 10px; text-align: center; font-size: 14px; color: #555;">
    ç½‘é¡µç‰ˆæƒæ¥è‡ªé—²é±¼å·ï¼šé’ç©º
  </footer>
</body>
</html>
