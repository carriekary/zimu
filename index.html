<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小野字幕君</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      width: 100%;
      gap: 20px;
    }
    .left-panel, .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .video-container {
      width: 100%;
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
    }
    .video-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: none;
    }
    .subtitle-container {
      width: 100%;
      height: 590px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 15px;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .subtitle {
      margin: 10px 0;
      padding: 12px;
      line-height: 1.8;
      font-size: 15px;
      font-weight: bold;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .color1 { color: #2c3e50; }
    .color2 { color: #e74c3c; }
    /* 笔记功能样式 */
    .note-container {
      width: 100%;
      max-width: 600px;
      margin-top: 15px;
      padding: 15px;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #noteInput {
      width: 100%;
      height: 100px;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="file"], input[type="text"], button {
      margin-top: 10px;
      padding: 10px;
      font-size: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      background: #fff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
  <!-- 引入 Mammoth.js 用于 DOCX 解析 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <!-- 引入 kuromoji.js 用于日语分词 -->
  <script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.js"></script>
</head>
<body>
  <h1>小野字幕君</h1>
  <div class="container">
    <!-- 左侧：视频搜索、播放与笔记功能 -->
    <div class="left-panel">
      <input type="text" id="videoUrl" placeholder="输入 Bilibili 或 泰剧网链接">
      <button onclick="loadVideo()">播放视频</button>
      <div class="video-container">
        <iframe id="videoFrame" class="video-iframe" allowfullscreen></iframe>
      </div>
      <!-- 添加笔记功能 -->
      <div class="note-container">
        <textarea id="noteInput" placeholder="在这里记录你的笔记..."></textarea>
        <button onclick="saveNote()">保存笔记</button>
        <div id="noteDisplay"></div>
      </div>
    </div>

    <!-- 右侧：文件选择、字幕解析和字幕搜索 -->
    <div class="right-panel">
      <input type="file" id="fileInput" accept=".ass,.srt,.docx">
      <input type="text" id="searchBox" placeholder="搜索字幕..." oninput="searchSubtitles()">
      <div class="subtitle-container">
        <div id="subtitles"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // 构建日文分词器（kuromoji）
    // ---------------------------
    let tokenizer = null;
    kuromoji.builder({
      // 确保将下载好的 dict 文件夹与此文件置于同目录下，
      // 或根据实际情况调整路径，如 "path/to/dict/"
      dicPath: "dict/"
    }).build((err, builtTokenizer) => {
      if (err) {
        console.error("构建分词器失败：", err);
        return;
      }
      tokenizer = builtTokenizer;
      console.log("kuromoji tokenizer 加载完毕！");
    });

    // ---------------------------
    // 片假名转平假名函数
    // ---------------------------
    function katakanaToHiragana(text) {
      return text.replace(/[\u30a1-\u30f6]/g, function(match) {
        return String.fromCharCode(match.charCodeAt(0) - 0x60);
      });
    }

    // ---------------------------
    // 自动添加平假名（Furigana）的函数
    // ---------------------------
    function addFuriganaToText(text) {
      // 如果 tokenizer 还没加载完，直接返回原文本
      if (!tokenizer) return text;
      const tokens = tokenizer.tokenize(text);
      let result = "";
      tokens.forEach(token => {
        // 如果 token 有读音并且包含汉字，则添加假名
        if (token.reading && /[一-龯]/.test(token.surface_form)) {
          let hiragana = katakanaToHiragana(token.reading);
          result += `<ruby>${token.surface_form}<rt>${hiragana}</rt></ruby>`;
        } else {
          result += token.surface_form;
        }
      });
      return result;
    }

    // ---------------------------
    // 视频播放功能
    // ---------------------------
    function loadVideo() {
      const inputUrl = document.getElementById('videoUrl').value.trim();
      const videoFrame = document.getElementById('videoFrame');
      try {
        const url = new URL(inputUrl);
        if (url.hostname.includes('bilibili.com')) {
          const bvid = getBilibiliId(inputUrl);
          if (bvid) {
            videoFrame.src = `https://player.bilibili.com/player.html?bvid=${bvid}&autoplay=0`;
            return;
          }
        } else if (url.hostname.includes('taijuwang.com')) {
          videoFrame.src = inputUrl;
          return;
        }
        throw new Error('不支持的平台或链接格式');
      } catch (e) {
        alert('⚠️ 错误: 请输入正确的视频链接');
      }
    }

    function getBilibiliId(url) {
      const match = url.match(/\/video\/(BV\w+)/);
      return match ? match[1] : null;
    }

    // ---------------------------
    // 文件解析相关
    // ---------------------------
    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          if (file.name.endsWith('.docx')) {
            parseDOCX(e.target.result, displaySubtitles);
          } else {
            const content = e.target.result;
            const subtitles = file.name.endsWith('.ass') ? parseASS(content) : parseSRT(content);
            displaySubtitles(subtitles);
          }
        } catch (error) {
          showError(`解析失败: ${error.message}`);
        }
      };
      reader.onerror = () => showError('文件读取失败');
      file.name.endsWith('.docx') ? reader.readAsArrayBuffer(file) : reader.readAsText(file, 'utf-8');
    });

    // 移除 BOM 的辅助函数
    function removeBOM(text) {
      return text.replace(/^\uFEFF/, '');
    }

    function parseASS(content) {
      return content.split('\n')
        .filter(line => line.startsWith('Dialogue:'))
        .map(line => {
          const parts = line.split(',');
          return { text: parts.slice(9).join(',').replace(/\\N/g, ' ').replace(/\{.*?\}/g, '') };
        });
    }

    function parseSRT(content) {
      content = removeBOM(content).replace(/\r/g, '');
      return content.split(/\n\n+/)
        .map(block => {
          const lines = block.split('\n').filter(l => l.trim());
          return lines.length >= 3 ? { text: lines.slice(2).join(' ') } : null;
        })
        .filter(Boolean);
    }

    function parseDOCX(arrayBuffer, callback) {
      mammoth.convertToHtml({ arrayBuffer }).then(result => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = result.value;
        const subtitles = Array.from(tempDiv.querySelectorAll('p'))
          .filter(p => p.textContent.trim() !== '')
          .map(p => ({ text: p.textContent.trim() }));
        callback(subtitles);
      }).catch(err => showError(`DOCX解析失败: ${err.message}`));
    }

    // ---------------------------
    // 显示字幕 —— 调用自动添加平假名函数
    // ---------------------------
    function displaySubtitles(subtitles) {
      const container = document.getElementById('subtitles');
      container.innerHTML = subtitles.map((sub, index) => `
        <div class="subtitle ${index % 2 ? 'color2' : 'color1'}">
          ${addFuriganaToText(sub.text || '空字幕内容')}
        </div>
      `).join('');
    }

    function showError(message) {
      const container = document.getElementById('subtitles');
      container.innerHTML = `<div class="subtitle color2">❌ ${message}</div>`;
    }

    function searchSubtitles() {
      const query = document.getElementById('searchBox').value.trim().toLowerCase();
      document.querySelectorAll('.subtitle').forEach(subtitle => {
        subtitle.style.display = subtitle.textContent.toLowerCase().includes(query) ? 'block' : 'none';
      });
    }

    // ---------------------------
    // 新增笔记保存功能
    // ---------------------------
    function saveNote() {
      const noteText = document.getElementById('noteInput').value.trim();
      if (!noteText) {
        alert("请输入笔记内容后再保存！");
        return;
      }
      document.getElementById('noteDisplay').innerHTML = `<p>📌 ${noteText}</p>`;
      alert("笔记已保存！");
    }
  </script>

  <footer style="margin-top: 20px; padding: 10px; text-align: center; font-size: 14px; color: #555;">
    网页版权来自闲鱼号：青空
  </footer>
</body>
</html>
